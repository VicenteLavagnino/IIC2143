<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <style>
        .user-select {
            display: block;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .user-select:hover {
            background-color: #e4e4e4;
            text-decoration: none;
        }

        .message {
            max-width: 60%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 15px;
        }

        .sent {
            background-color: #DCF8C6;
            margin-left: auto;
        }

        .received {
            background-color: #EDEDED;
            margin-right: auto;
        }

        .chat-box {
            display: flex;
            flex-direction: column;
            height: 400px;
            overflow-y: auto;
        }

        .recipient-name {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .message-input-area {
            width: 100;
        }

        .message-input {
            width: 750px;
            height: 120px;
            border: 2px solid #007BFF;
            border-radius: 8px;
            resize: none;
            padding: 10px;
            box-sizing: border-box;
        }

        .send-button {
            flex-shrink: 0;
        }

    </style>
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title has-text-centered">Lobby de Mensajería</h1>
            <div class="columns">
                <!-- Columna Izquierda -->
                <div class="column is-one-third">
                    <!-- Lista de Usuarios -->
                    <div class="box">
                        <h3 class="subtitle">Usuarios</h3>
                        <% if @users.present? %>
                        <% @users.each do |user| %>
                        <% next if user == current_user %>
                        <a class="user-select" href="<%= start_chat_path(user.id) %>">
                            <p><%= user.name %></p>
                        </a>
                        <% end %>
                        <% else %>
                        <p>Eres el único perfil que existe (literal).</p>
                        <% end %>
                    </div>

                    <div class="box">
    <h3 class="subtitle">Mis Chats</h3>
    
    <% chats_with_messages = @chats.select { |chat| (chat.user1_id == current_user.id || chat.user2_id == current_user.id) && chat.messages.any? } %>
    
    <% if chats_with_messages.any? %>
        <% chats_with_messages.each do |chat| %>
            <% recipient = chat.user1_id == current_user.id ? User.find(chat.user2_id) : User.find(chat.user1_id) %>
            <a href="<%= start_chat_path(recipient.id) %>">
                <p><%= recipient.name %></p>
            </a>
        <% end %>
    <% else %>
        <p>No tienes chats activos.</p>
    <% end %>
</div>

                </div>

                <!-- Columna Derecha: Chat Abierto -->
                <div class="column is-two-thirds">
                    <div class="box">
                        <% if @recipient %>
                        <h2 class="recipient-name"><%= @recipient.name %></h2>
                        <% end %>

                        <div class="chat-box">
                            <% if @chat %> <!-- Comprobar si hay un chat en primer lugar -->
                            <% if @messages&.any? %>
                            <% previous_user = nil %> 
                            <% @messages.each do |message| %>
                            <% if message.user == current_user %>
                            <div class="message sent">
                                <%= message.content %>
                            </div>
                            <% else %>
                            <div class="message received">
                                <%= message.content %>
                            </div>
                            <% end %>
                            <% end %>
                            <% else %> 
                            <!-- Si hay un chat pero todavía no tiene mensajes -->
                            <p>COMIENZA A CHATEAR</p>
                            <% end %>
                            <% else %>
                            <!-- Si no hay chat en absoluto -->
                            <p>CHATEA CON ALGUIEN</p>
                            <% end %>
                        </div>

                        <div class="message-input-area field has-addons">
                            <% if @chat %>
                            <%= form_for [ @chat, @chat.messages.build ] do |f| %>
                            <div class="control is-expanded">
                                <%= f.text_area :content, placeholder: 'Escribe tu mensaje aquí...', rows: 4, class: 'textarea message-input' %>
                            </div>
                            <div class="control">
                                <%= f.submit 'Enviar', class: 'button is-primary send-button' %>
                            </div>
                            <% end %>
                            <% else %>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
        /* ... (Script sin cambios) ... */
    </script>
</body>

</html>
